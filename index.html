<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Travel JSON Editor Pro</title>
  <style>
    :root {
      --bg: #f8f9fc;
      --panel: #ffffff;
      --text: #111827;
      --text-sec: #6b7280;
      --border: #e2e8f0;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --primary-fg: #ffffff;
      --danger: #ef4444;
      --success: #10b981;
      --ring: rgba(59, 130, 246, 0.5);
      --radius: 12px;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.1);
      --font-mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", "Courier New", monospace;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --panel: #1e293b;
      --text: #f1f5f9;
      --text-sec: #94a3b8;
      --border: #334155;
      --primary: #60a5fa;
      --primary-hover: #3b82f6;
      --ring: rgba(96, 165, 250, 0.5);
      --shadow: 0 1px 3px 0 rgba(0,0,0,0.5);
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      margin: 0;
      font-family: system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      transition: background 0.3s, color 0.3s;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    /* --- Layout --- */
    header {
      flex-shrink: 0;
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 24px;
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      z-index: 20;
    }

    .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; }
    .brand svg { width: 24px; height: 24px; color: var(--primary); }
    
    .stats-bar {
      display: flex; gap: 16px; font-size: 0.85rem; color: var(--text-sec);
      background: var(--bg); padding: 4px 12px; border-radius: 99px; border: 1px solid var(--border);
    }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 420px;
      flex: 1;
      overflow: hidden;
    }

    .editor-col {
      overflow-y: auto;
      padding: 24px;
      scroll-behavior: smooth;
    }

    .preview-col {
      background: #111827; /* Always dark for code */
      color: #e2e8f0;
      display: flex; flex-direction: column;
      border-left: 1px solid var(--border);
      position: relative;
    }

    /* --- Components --- */
    .btn {
      display: inline-flex; align-items: center; gap: 6px; justify-content: center;
      padding: 8px 14px; border-radius: 8px; font-weight: 500; font-size: 0.9rem;
      cursor: pointer; transition: all 0.2s; border: 1px solid var(--border);
      background: var(--panel); color: var(--text);
    }
    .btn:hover { background: var(--bg); border-color: var(--text-sec); }
    .btn:active { transform: translateY(1px); }
    .btn-primary { background: var(--primary); color: #fff; border-color: transparent; }
    .btn-primary:hover { background: var(--primary-hover); }
    .btn-icon { padding: 6px; border-radius: 6px; color: var(--text-sec); border: none; background: transparent; }
    .btn-icon:hover { background: var(--bg); color: var(--text); }
    .btn-sm { padding: 4px 8px; font-size: 0.8rem; }
    .btn-danger { color: var(--danger); border-color: transparent; background: transparent; }
    .btn-danger:hover { background: rgba(239, 68, 68, 0.1); }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      overflow: hidden;
      transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: var(--shadow-lg); }

    .card-header {
      padding: 16px;
      display: flex; align-items: center; justify-content: space-between;
      border-bottom: 1px solid var(--border);
      background: var(--bg);
      cursor: pointer; user-select: none;
    }
    .card-header h3 { margin: 0; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
    
    .card-body { padding: 16px; display: none; }
    .card.open .card-body { display: block; animation: slideDown 0.2s ease-out; }

    @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

    /* Forms */
    input[type="text"], input[type="number"] {
      width: 100%;
      padding: 8px 12px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.95rem;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px var(--ring); }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .section-label { 
      font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; 
      color: var(--text-sec); margin: 0 0 8px 0; font-weight: 700; 
    }

    /* Tags/Chips */
    .chip-list { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 8px; }
    .chip {
      display: inline-flex; align-items: center; gap: 6px;
      background: var(--bg); border: 1px solid var(--border);
      border-radius: 99px; padding: 4px 10px; font-size: 0.85rem; font-weight: 500;
    }
    .chip button { 
      border: none; background: none; padding: 0; font-size: 1.1em; 
      line-height: 1; color: var(--text-sec); cursor: pointer; display: flex; 
    }
    .chip button:hover { color: var(--danger); }

    /* Switch */
    .switch-row { display: flex; flex-wrap: wrap; gap: 16px; margin-bottom: 16px; }
    .switch { display: inline-flex; align-items: center; gap: 8px; cursor: pointer; font-size: 0.9rem; user-select: none; }
    .switch input { appearance: none; width: 36px; height: 20px; background: var(--border); border-radius: 20px; position: relative; transition: .2s; }
    .switch input:checked { background: var(--primary); }
    .switch input::after { content:""; position: absolute; top: 2px; left: 2px; width: 16px; height: 16px; background: #fff; border-radius: 50%; transition: .2s; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .switch input:checked::after { transform: translateX(16px); }

    /* City List */
    .city-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
    .city-table th { text-align: left; padding: 8px; color: var(--text-sec); font-weight: 500; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
    .city-table td { padding: 8px; border-bottom: 1px solid var(--border); vertical-align: top; }
    .city-table tr:last-child td { border-bottom: none; }
    .city-years { display: flex; flex-wrap: wrap; gap: 4px; }
    .year-badge { 
      background: var(--primary); color: #fff; font-size: 0.75rem; 
      padding: 2px 6px; border-radius: 4px; cursor: help; 
    }
    .year-badge.legacy { background: var(--text-sec); opacity: 0.5; }

    /* Preview Area */
    .code-toolbar {
      padding: 8px 16px; border-bottom: 1px solid #334155;
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(0,0,0,0.2);
    }
    #preview {
      flex: 1; margin: 0; padding: 16px; overflow: auto;
      font-family: var(--font-mono); font-size: 13px; line-height: 1.5;
    }

    /* Modal */
    .modal-backdrop {
      position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(2px);
      z-index: 50; display: none; place-items: center;
    }
    .modal-backdrop.show { display: grid; }
    .modal {
      background: var(--panel); width: 90%; max-width: 600px;
      border-radius: 16px; box-shadow: var(--shadow-lg);
      border: 1px solid var(--border); display: flex; flex-direction: column;
    }
    .modal-head { padding: 16px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
    .modal-body { padding: 16px; }
    textarea.json-input { 
      width: 100%; height: 300px; font-family: var(--font-mono); font-size: 13px;
      padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg); color: var(--text); resize: vertical;
    }

    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr; overflow-y: auto; }
      .editor-col { overflow: visible; height: auto; }
      .preview-col { height: 400px; border-top: 1px solid var(--border); border-left: none; }
      body { overflow: auto; }
    }
  </style>
</head>
<body>

  <header>
    <div class="brand">
      <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"/>
        <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
      </svg>
      Travel Editor <span style="font-weight:400; color:var(--text-sec); font-size:0.9em; margin-left:4px">Pro</span>
    </div>

    <div class="actions" style="display:flex; align-items:center; gap:12px">
      <div class="stats-bar" id="statsBar">
        <span>0 Countries</span>
        <span style="border-left:1px solid var(--border); height:14px"></span>
        <span>0 Cities</span>
      </div>
      <button class="btn btn-icon" id="themeToggle" title="Toggle Dark Mode">
        <svg id="moonIcon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        <svg id="sunIcon" style="display:none" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
      </button>
      <button class="btn" id="importBtn">Import</button>
      <button class="btn btn-primary" id="downloadBtn">
        Download JSON
      </button>
    </div>
  </header>

  <main class="main-grid">
    <div class="editor-col">
      
      <div class="card open">
        <div class="card-header" onclick="toggleCard(this)">
          <h3>Person Info</h3>
        </div>
        <div class="card-body">
          <div class="section-label">Birthplace</div>
          <input type="text" id="personCountry" placeholder="Birthplace Country (e.g. Ukraine)" />
        </div>
      </div>

      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
        <h2 style="font-size:1.2rem; margin:0">Visited Countries</h2>
        <button class="btn btn-primary" id="addCountryBtn">
          <span style="font-size:1.2em; line-height:0.8; margin-bottom:2px">+</span> Add Country
        </button>
      </div>

      <div id="countriesList"></div>

      <div style="margin-top:30px; text-align:center; color:var(--text-sec); font-size:0.9rem">
        <button class="btn btn-danger" id="resetBtn">Reset All Data</button>
      </div>
    </div>

    <div class="preview-col">
      <div class="code-toolbar">
        <span style="font-weight:600; font-size:0.85rem; color:#94a3b8">JSON PREVIEW</span>
        <button class="btn btn-sm" id="copyBtn" style="background:#334155; border:none; color:#fff">Copy</button>
      </div>
      <pre id="preview"></pre>
    </div>
  </main>

  <div class="modal-backdrop" id="importModal">
    <div class="modal">
      <div class="modal-head">
        <strong>Import JSON</strong>
        <button class="btn btn-icon" onclick="closeImport()">✕</button>
      </div>
      <div class="modal-body">
        <p style="margin-top:0; color:var(--text-sec); font-size:0.9rem">Paste your JSON structure below. It will overwrite current data.</p>
        <textarea id="importText" class="json-input" placeholder='{ "person": ... }'></textarea>
        <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px">
          <button class="btn" onclick="closeImport()">Cancel</button>
          <button class="btn btn-primary" id="confirmImport">Import Data</button>
        </div>
        <div id="importError" style="color:var(--danger); font-size:0.9rem; margin-top:8px; display:none"></div>
      </div>
    </div>
  </div>

  <script>
    /** * --- STATE & DEFAULTS --- 
     */
    const DEFAULT_DATA = {
      person: { birthplace: { country: "" } },
      travel: { countries: [] }
    };

    let state = loadState();
    // UI state to remember which cards are open (set of indices)
    let openCards = new Set([0]); 

    /**
     * --- DOM HELPER ---
     * Creates elements cleaner than document.createElement
     */
    function el(tag, props = {}, ...children) {
      const element = document.createElement(tag);
      for (let [key, val] of Object.entries(props)) {
        if (key.startsWith('on') && typeof val === 'function') {
          element.addEventListener(key.substring(2).toLowerCase(), val);
        } else if (key === 'className') {
          element.className = val;
        } else if (key === 'value') {
          element.value = val;
        } else if (key === 'checked') {
          element.checked = val;
        } else if (val !== false && val !== null && val !== undefined) {
          element.setAttribute(key, val);
        }
      }
      children.forEach(child => {
        if (typeof child === 'string' || typeof child === 'number') {
          element.appendChild(document.createTextNode(child));
        } else if (child instanceof Node) {
          element.appendChild(child);
        }
      });
      return element;
    }

    /**
     * --- MAIN RENDERER ---
     */
    function render() {
      // 1. Person
      const personInput = document.getElementById('personCountry');
      if (document.activeElement !== personInput) {
        personInput.value = state.person.birthplace.country || '';
      }

      // 2. Stats
      const countryCount = state.travel.countries.length;
      const cityCount = state.travel.countries.reduce((acc, c) => acc + (c.cities ? c.cities.length : 0), 0);
      const statsBar = document.getElementById('statsBar');
      statsBar.innerHTML = '';
      statsBar.append(
        el('span', {}, `${countryCount} Countr${countryCount===1?'y':'ies'}`),
        el('span', {style:'border-left:1px solid var(--border); height:14px'}),
        el('span', {}, `${cityCount} Cit${cityCount===1?'y':'ies'}`)
      );

      // 3. Countries List
      const container = document.getElementById('countriesList');
      container.innerHTML = '';

      state.travel.countries.forEach((country, idx) => {
        const isOpen = openCards.has(idx);
        
        // --- Header ---
        const header = el('div', { className: 'card-header', onclick: () => toggleCardState(idx) },
          el('h3', {}, 
            el('span', {style:'color:var(--text-sec); font-weight:400; font-size:0.9em; width:20px'}, `#${idx+1}`),
            country.name || el('i', {style:'opacity:0.5'}, 'Unnamed Country')
          ),
          el('div', { onclick: (e)=>e.stopPropagation(), style:'display:flex; gap:4px' },
            // Move Up
            el('button', { 
              className: 'btn btn-icon', title: 'Move Up', disabled: idx===0,
              onclick: () => moveCountry(idx, -1) 
            }, '↑'),
            // Move Down
            el('button', { 
              className: 'btn btn-icon', title: 'Move Down', disabled: idx===state.travel.countries.length-1,
              onclick: () => moveCountry(idx, 1) 
            }, '↓'),
            // Delete
            el('button', { 
              className: 'btn btn-icon', title: 'Delete', style:'color:var(--danger)',
              onclick: () => deleteCountry(idx) 
            }, '✕')
          )
        );

        // --- Body ---
        const body = el('div', { className: 'card-body' });

        // Name Input
        body.appendChild(el('div', {style:'margin-bottom:16px'},
          el('div', {className:'section-label'}, 'Country Name'),
          el('input', { 
            type:'text', value: country.name, placeholder:'e.g. France',
            oninput: (e) => { country.name = e.target.value; update(); }
          })
        ));

        // Switches
        const switches = el('div', {className:'switch-row'});
        const makeSwitch = (label, path) => {
          const val = getNested(country, path);
          return el('label', {className:'switch'},
            el('input', { type:'checkbox', checked: !!val, onchange: (e) => { setNested(country, path, e.target.checked); update(); } }),
            el('span', {}, label)
          );
        };
        switches.append(
          makeSwitch('Visited', 'status.visited'),
          makeSwitch('Lived', 'status.lived'),
          makeSwitch('Birthplace', 'status.birthplace'),
          makeSwitch('Visited Capital', 'capitalVisit.visited')
        );
        body.appendChild(switches);

        // Grid for Timelines
        const grid = el('div', {className:'grid-2'});
        
        // Helper for Tag Lists (Years/Lived)
        const makeTagInput = (label, arr, placeholder) => {
          const wrapper = el('div', {});
          wrapper.appendChild(el('div', {className:'section-label'}, label));
          
          const list = el('div', {className:'chip-list'});
          arr.forEach((tag, tagIdx) => {
            list.appendChild(el('span', {className:'chip'}, 
              tag, 
              el('button', { onclick:()=>{ arr.splice(tagIdx, 1); update(); } }, '×')
            ));
          });
          wrapper.appendChild(list);

          const inputRow = el('div', {style:'display:flex; gap:8px'});
          const input = el('input', { type:'text', placeholder: placeholder, style:'min-width:0' });
          const addBtn = el('button', { className:'btn btn-sm', onclick: () => {
             if(input.value.trim()){ arr.push(normalizeYear(input.value)); input.value=''; update(); }
          }}, 'Add');
          input.addEventListener('keydown', e => { if(e.key==='Enter') addBtn.click(); });
          
          inputRow.append(input, addBtn);
          wrapper.appendChild(inputRow);
          return wrapper;
        };

        grid.append(
          makeTagInput('Visited Years', country.timeline.visited, 'YYYY'),
          makeTagInput('Lived Periods', country.timeline.lived, 'e.g. 2018-2020')
        );
        body.appendChild(grid);

        // --- Cities Section ---
        body.appendChild(el('hr', {style:'border:0; border-top:1px solid var(--border); margin:20px 0'}));
        
        const cityHeader = el('div', {style:'display:flex; justify-content:space-between; align-items:end; margin-bottom:12px'},
          el('div', {className:'section-label', style:'margin:0'}, 'Cities & Years'),
        );
        body.appendChild(cityHeader);

        // Cities Table
        if(country.cities.length > 0) {
          const table = el('table', {className:'city-table'});
          table.innerHTML = `<thead><tr><th style="width:35%">Name</th><th>Visited Years</th><th style="width:40px"></th></tr></thead>`;
          const tbody = el('tbody');
          
          country.cities.forEach((city, cIdx) => {
            const tr = el('tr');
            
            // Name Cell
            const tdName = el('td');
            const nameInp = el('input', {
              type:'text', value:city.name, 
              style:'padding:4px 8px; font-size:0.9rem',
              onchange: (e) => { city.name = e.target.value; update(); }
            });
            tdName.appendChild(nameInp);

            // Years Cell
            const tdYears = el('td');
            const yearsWrap = el('div', {className:'city-years'});
            
            // Render existing years
            (city.timeline.visited || []).sort((a,b)=>parseInt(a)-parseInt(b)).forEach((y, yIdx) => {
              const chip = el('span', {className:'year-badge', title:'Click to remove', onclick:()=>{
                city.timeline.visited.splice(yIdx,1); update();
              }}, y);
              yearsWrap.appendChild(chip);
            });
            
            // Add Year Inline
            const addYInput = el('input', {
              type:'text', placeholder:'+ Year', 
              style:'width:60px; padding:2px 6px; font-size:0.8rem; margin-left:4px; display:inline-block',
              onkeydown: (e) => {
                if(e.key === 'Enter') {
                  const val = normalizeYear(e.target.value);
                  if(val) {
                    if(!city.timeline.visited) city.timeline.visited = [];
                    if(!city.timeline.visited.includes(val)) city.timeline.visited.push(val);
                    update();
                  }
                }
              }
            });
            yearsWrap.appendChild(addYInput);
            tdYears.appendChild(yearsWrap);

            // Action Cell
            const tdAct = el('td', {}, 
              el('button', {
                className:'btn btn-icon', style:'color:var(--text-sec)',
                onclick: () => { country.cities.splice(cIdx, 1); update(); }
              }, '✕')
            );

            tr.append(tdName, tdYears, tdAct);
            tbody.appendChild(tr);
          });
          table.appendChild(tbody);
          body.appendChild(table);
        } else {
          body.appendChild(el('div', {style:'color:var(--text-sec); font-size:0.9rem; font-style:italic; margin-bottom:10px'}, 'No cities added yet.'));
        }

        // Add City Row
        const addCityRow = el('div', {style:'display:flex; gap:8px; margin-top:12px; background:var(--bg); padding:8px; border-radius:8px; border:1px dashed var(--border)'});
        const newCityName = el('input', {type:'text', placeholder:'New City Name'});
        const newCityYear = el('input', {type:'text', placeholder:'Year (Optional)', style:'width:120px'});
        const addCityBtn = el('button', { className:'btn btn-sm', onclick: () => {
          if(newCityName.value.trim()){
            const y = normalizeYear(newCityYear.value) || new Date().getFullYear();
            country.cities.unshift({
              name: newCityName.value.trim(),
              timeline: { visited: [y] }
            });
            update();
          }
        }}, 'Add City');

        // Allow Enter key
        const enterHandler = (e) => { if(e.key==='Enter') addCityBtn.click(); };
        newCityName.addEventListener('keydown', enterHandler);
        newCityYear.addEventListener('keydown', enterHandler);

        addCityRow.append(newCityName, newCityYear, addCityBtn);
        body.appendChild(addCityRow);


        // --- Assemble Card ---
        const card = el('div', { className: `card ${isOpen ? 'open' : ''}` });
        card.append(header, body);
        container.appendChild(card);
      });

      // 4. JSON Preview
      const jsonStr = JSON.stringify(state, null, 2);
      document.getElementById('preview').textContent = jsonStr;
      
      // Save
      localStorage.setItem('travel-editor-v2', jsonStr);
    }

    /**
     * --- LOGIC & UTILS ---
     */
    function update() { render(); }
    
    function loadState() {
      try {
        const raw = localStorage.getItem('travel-editor-v2');
        return raw ? JSON.parse(raw) : JSON.parse(JSON.stringify(DEFAULT_DATA));
      } catch { return JSON.parse(JSON.stringify(DEFAULT_DATA)); }
    }

    // Toggles Accordion
    function toggleCardState(idx) {
      if (openCards.has(idx)) openCards.delete(idx);
      else openCards.add(idx);
      render();
    }
    // Simple global handler for the `onclick` in HTML to work
    window.toggleCard = function(el) { /* handled by toggleCardState logic inside render */ };

    function normalizeYear(val) {
      if(!val) return null;
      const s = String(val).trim();
      if(!s) return null;
      const n = parseInt(s);
      return isNaN(n) ? s : n;
    }

    function moveCountry(idx, dir) {
      const arr = state.travel.countries;
      const target = idx + dir;
      if (target >= 0 && target < arr.length) {
        [arr[idx], arr[target]] = [arr[target], arr[idx]];
        // Adjust open card index
        const wasOpen = openCards.has(idx);
        const targetWasOpen = openCards.has(target);
        if(wasOpen) openCards.add(target); else openCards.delete(target);
        if(targetWasOpen) openCards.add(idx); else openCards.delete(idx);
        update();
      }
    }

    function deleteCountry(idx) {
      if(confirm('Delete this country and all its data?')) {
        state.travel.countries.splice(idx, 1);
        openCards.delete(idx);
        // Shift indices in set greater than idx? Too complex, just clear or reset.
        // Let's just clear selection to be safe
        openCards.clear();
        update();
      }
    }

    // Nested object access helper
    function getNested(obj, path) {
      return path.split('.').reduce((o, i) => o ? o[i] : null, obj);
    }
    function setNested(obj, path, val) {
      const keys = path.split('.');
      const last = keys.pop();
      const target = keys.reduce((o, i) => o[i], obj);
      if(target) target[last] = val;
    }

    // --- EVENTS ---

    document.getElementById('personCountry').addEventListener('input', (e) => {
      state.person.birthplace.country = e.target.value;
      update();
    });

    document.getElementById('addCountryBtn').addEventListener('click', () => {
      state.travel.countries.unshift({
        name: "",
        status: { visited: true, lived: false, birthplace: false },
        capitalVisit: { visited: false },
        timeline: { visited: [], lived: [] },
        cities: []
      });
      // Correct indices for open cards
      const newOpen = new Set();
      newOpen.add(0); // Open the new one
      for(let i of openCards) newOpen.add(i + 1);
      openCards = newOpen;
      update();
    });

    document.getElementById('copyBtn').addEventListener('click', (e) => {
      navigator.clipboard.writeText(JSON.stringify(state, null, 2));
      const orig = e.target.textContent;
      e.target.textContent = 'Copied!';
      setTimeout(() => e.target.textContent = orig, 1500);
    });

    document.getElementById('downloadBtn').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], {type: 'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'travel_data.json';
      a.click();
    });

    document.getElementById('resetBtn').addEventListener('click', () => {
      if(confirm('Are you sure you want to delete all data?')) {
        state = JSON.parse(JSON.stringify(DEFAULT_DATA));
        openCards.clear();
        update();
      }
    });

    // Theme Toggle
    const themeBtn = document.getElementById('themeToggle');
    const moon = document.getElementById('moonIcon');
    const sun = document.getElementById('sunIcon');
    
    function setTheme(isDark) {
      document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
      moon.style.display = isDark ? 'none' : 'block';
      sun.style.display = isDark ? 'block' : 'none';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }

    themeBtn.addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      setTheme(!isDark);
    });

    // Init Theme
    if (localStorage.getItem('theme') === 'dark' || 
       (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      setTheme(true);
    }

    // Import Logic
    const importModal = document.getElementById('importModal');
    document.getElementById('importBtn').addEventListener('click', () => {
      importModal.classList.add('show');
      document.getElementById('importText').value = '';
      document.getElementById('importError').style.display='none';
    });
    window.closeImport = () => importModal.classList.remove('show');
    
    document.getElementById('confirmImport').addEventListener('click', () => {
      const raw = document.getElementById('importText').value;
      const errEl = document.getElementById('importError');
      try {
        const parsed = JSON.parse(raw);
        // Basic schema validation could go here
        if(!parsed.travel || !Array.isArray(parsed.travel.countries)) throw new Error("Invalid structure: missing travel.countries array");
        
        state = parsed;
        openCards.clear();
        update();
        closeImport();
      } catch(e) {
        errEl.textContent = 'Error: ' + e.message;
        errEl.style.display = 'block';
      }
    });

    // Init
    update();

  </script>
</body>
</html>

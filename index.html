<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Travel JSON Editor Pro</title>
  <style>
    :root {
      --bg: #f9fafb;
      --panel: #ffffff;
      --text: #111827;
      --text-sec: #6b7280;
      --primary: #3b82f6;
      --primary-hover: #2563eb;
      --primary-fg: #ffffff;
      --danger: #ef4444;
      --border: #e5e7eb;
      --input-bg: #ffffff;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
      --font-sans: system-ui, -apple-system, sans-serif;
    }

    [data-theme="dark"] {
      --bg: #0f172a;
      --panel: #1e293b;
      --text: #f3f4f6;
      --text-sec: #9ca3af;
      --primary: #60a5fa;
      --primary-hover: #3b82f6;
      --primary-fg: #0f172a;
      --danger: #f87171;
      --border: #334155;
      --input-bg: #0f172a;
      --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.3);
    }

    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: var(--font-sans);
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      transition: background 0.3s, color 0.3s;
    }

    /* Layout */
    .app-shell {
      display: grid;
      grid-template-rows: auto 1fr;
      height: 100vh;
      overflow: hidden;
    }
    
    header {
      background: var(--panel);
      border-bottom: 1px solid var(--border);
      padding: 12px 24px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      z-index: 10;
      box-shadow: var(--shadow);
    }

    .brand { display: flex; align-items: center; gap: 12px; font-weight: 700; font-size: 1.1rem; }
    .brand svg { color: var(--primary); }

    .main-grid {
      display: grid;
      grid-template-columns: 1fr 420px;
      overflow: hidden;
      height: 100%;
    }

    /* Scroll Areas */
    .scroll-area { overflow-y: auto; padding: 24px; height: 100%; }
    .sidebar { 
      background: var(--panel); 
      border-left: 1px solid var(--border); 
      display: flex; 
      flex-direction: column; 
    }

    /* Components */
    .btn {
      display: inline-flex; align-items: center; gap: 6px;
      padding: 8px 14px;
      border-radius: var(--radius-sm);
      font-size: 0.875rem; font-weight: 500;
      cursor: pointer; border: 1px solid var(--border);
      background: var(--panel); color: var(--text);
      transition: all 0.2s;
    }
    .btn:hover { background: var(--bg); border-color: var(--text-sec); }
    .btn-primary { background: var(--primary); color: var(--primary-fg); border-color: transparent; }
    .btn-primary:hover { background: var(--primary-hover); border-color: transparent; }
    .btn-danger { color: var(--danger); border-color: transparent; background: transparent; }
    .btn-danger:hover { background: rgba(239,68,68, 0.1); }
    .btn-icon { padding: 8px; }

    input[type="text"], input[type="search"], textarea {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 8px 12px;
      border-radius: var(--radius-sm);
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus, textarea:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
    }

    /* Stats Bar */
    .stats-bar {
      display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 24px;
    }
    .stat-card {
      background: var(--panel); border: 1px solid var(--border); padding: 12px 16px; border-radius: var(--radius);
      display: flex; flex-direction: column;
    }
    .stat-val { font-size: 1.5rem; font-weight: 700; color: var(--primary); line-height: 1.2; }
    .stat-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-sec); }

    /* Controls Bar */
    .controls { display: flex; gap: 12px; margin-bottom: 16px; }
    .search-box { flex: 1; position: relative; }

    /* Country Card */
    .country-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 16px;
      overflow: hidden;
      transition: border-color 0.2s;
    }
    .country-card:hover { border-color: var(--primary); }
    
    .c-header {
      padding: 12px 16px;
      background: rgba(0,0,0,0.02);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 12px;
      cursor: pointer; user-select: none;
    }
    .c-title { font-weight: 600; flex: 1; display: flex; align-items: center; gap: 8px; }
    .c-actions { display: flex; gap: 4px; align-items: center; }
    
    .c-body { padding: 16px; display: none; }
    .c-body.open { display: block; animation: slideDown 0.2s ease; }

    @keyframes slideDown { from {opacity:0; transform:translateY(-5px)} to {opacity:1; transform:translateY(0)} }

    .badge {
      font-size: 0.7rem; padding: 2px 8px; border-radius: 99px; font-weight: 600;
      background: var(--border); color: var(--text-sec);
    }
    .badge.green { background: #dcfce7; color: #166534; }
    [data-theme="dark"] .badge.green { background: #14532d; color: #bbf7d0; }

    /* Toggles & Tags */
    .toggles-row { display: flex; gap: 20px; margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid var(--border); }
    .switch-label { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; cursor: pointer; }
    
    .tag-container { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .tag {
      background: var(--bg); border: 1px solid var(--border); padding: 4px 10px; border-radius: 6px; font-size: 0.85rem;
      display: inline-flex; align-items: center; gap: 6px;
    }
    .tag button { border: none; background: none; color: var(--text-sec); cursor: pointer; padding: 0; font-size: 1.1em; display: flex; }
    .tag button:hover { color: var(--danger); }

    /* City Row */
    .city-row {
      display: grid; grid-template-columns: 2fr 3fr auto; gap: 12px; align-items: start;
      padding: 12px; background: var(--bg); border-radius: var(--radius-sm); border: 1px solid var(--border); margin-bottom: 8px;
    }
    .year-badges { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; }
    .year-badge {
      font-size: 0.75rem; background: var(--panel); border: 1px solid var(--border);
      padding: 2px 6px; border-radius: 4px; display: inline-flex; align-items: center; gap: 4px;
    }

    /* JSON Preview */
    .json-preview {
      background: #0d1117; color: #e6edf3;
      padding: 16px; margin: 0; overflow: auto;
      font-family: 'Menlo', 'Monaco', monospace; font-size: 0.8rem;
      height: 100%; border: none;
    }

    /* Modal */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px);
      z-index: 50; display: none; place-items: center;
    }
    .modal-overlay.show { display: grid; }
    .modal { background: var(--panel); width: 90%; max-width: 600px; border-radius: var(--radius); padding: 24px; box-shadow: var(--shadow); }
    
    /* Utility */
    .flex-col { display: flex; flex-direction: column; gap: 4px; }
    .text-sm { font-size: 0.85rem; color: var(--text-sec); }
    .hidden { display: none !important; }

    @media (max-width: 900px) {
      .main-grid { grid-template-columns: 1fr; grid-template-rows: 1fr auto; }
      .sidebar { border-left: none; border-top: 1px solid var(--border); height: 300px; }
    }
  </style>
</head>
<body>

<div class="app-shell">
  <header>
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M2 12h20M2 12l5-5m-5 5l5 5"/>
        <path d="M22 12l-5-5m5 5l-5 5" opacity="0"/> <circle cx="12" cy="12" r="10"/>
        <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
      </svg>
      Travel Editor
    </div>
    <div style="display:flex; gap:8px">
      <button class="btn" id="themeToggle" title="Toggle Dark Mode">â—‘</button>
      <button class="btn" onclick="app.importJson()">Import</button>
      <button class="btn" onclick="app.resetData()">Reset</button>
      <button class="btn btn-primary" onclick="app.downloadJson()">Download JSON</button>
    </div>
  </header>

  <div class="main-grid">
    <main class="scroll-area">
      
      <div class="stats-bar" id="statsBar">
        <div class="stat-card">
          <span class="stat-val" id="statVisited">0</span>
          <span class="stat-label">Countries Visited</span>
        </div>
        <div class="stat-card">
          <span class="stat-val" id="statCities">0</span>
          <span class="stat-label">Cities Logged</span>
        </div>
        <div class="stat-card" style="justify-content:center">
          <div class="flex-col">
            <span class="stat-label">Birthplace</span>
            <input type="text" id="birthplaceInput" placeholder="Enter Country" style="margin-top:4px">
          </div>
        </div>
      </div>

      <div class="controls">
        <div class="search-box">
          <input type="search" id="searchInput" placeholder="Search countries..." oninput="app.handleSearch(this.value)">
        </div>
        <button class="btn" onclick="app.sortCountries('name')">Sort A-Z</button>
        <button class="btn" onclick="app.sortCountries('visited')">Sort Visited</button>
        <button class="btn btn-primary" onclick="app.addCountry()">+ Add Country</button>
      </div>

      <div id="countriesList"></div>
      
      <div id="emptyState" class="hidden" style="text-align:center; padding:40px; color:var(--text-sec)">
        No countries match your search.
      </div>
    </main>

    <aside class="sidebar">
      <div style="padding:12px 16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center; background:var(--panel)">
        <span style="font-weight:600; font-size:0.9rem">Live JSON Preview</span>
        <button class="btn" style="font-size:0.75rem; padding:4px 8px" onclick="app.copyJson()">Copy</button>
      </div>
      <pre id="jsonPreview" class="json-preview"></pre>
    </aside>
  </div>
</div>

<div class="modal-overlay" id="importModal">
  <div class="modal">
    <h3 style="margin-top:0">Import JSON</h3>
    <textarea id="importArea" rows="10" placeholder="Paste your JSON here..."></textarea>
    <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:16px">
      <button class="btn" onclick="document.getElementById('importModal').classList.remove('show')">Cancel</button>
      <button class="btn btn-primary" onclick="app.confirmImport()">Load Data</button>
    </div>
  </div>
</div>

<script>
/**
 * Travel Editor Pro Logic
 * Organized into a clean Module pattern
 */
const app = (() => {
  // --- State ---
  const DEFAULT_DATA = {
    person: { birthplace: { country: "" } },
    travel: { countries: [] }
  };
  
  let data = structuredClone(DEFAULT_DATA);
  let viewState = {
    search: "",
    expanded: new Set() // stores IDs (indices) of expanded countries
  };

  // --- DOM Elements ---
  const els = {
    list: document.getElementById('countriesList'),
    preview: document.getElementById('jsonPreview'),
    birthplace: document.getElementById('birthplaceInput'),
    statsVisited: document.getElementById('statVisited'),
    statsCities: document.getElementById('statCities'),
    empty: document.getElementById('emptyState'),
    importModal: document.getElementById('importModal'),
    importArea: document.getElementById('importArea'),
    themeToggle: document.getElementById('themeToggle')
  };

  // --- Initialization ---
  function init() {
    loadData();
    initTheme();
    render();
    
    // Bind global listener for birthplace
    els.birthplace.addEventListener('input', (e) => {
      data.person.birthplace.country = e.target.value;
      update();
    });
  }

  // --- Theme ---
  function initTheme() {
    const saved = localStorage.getItem('theme');
    if (saved === 'dark' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
      document.documentElement.setAttribute('data-theme', 'dark');
    }
    els.themeToggle.addEventListener('click', () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      document.documentElement.setAttribute('data-theme', isDark ? 'light' : 'dark');
      localStorage.setItem('theme', isDark ? 'light' : 'dark');
    });
  }

  // --- Data Management ---
  function loadData() {
    const raw = localStorage.getItem('travel_editor_data');
    if (raw) {
      try {
        const parsed = JSON.parse(raw);
        data = normalizeData(parsed);
      } catch (e) { console.error("Load failed", e); }
    }
    // Set initial birthplace input
    els.birthplace.value = data.person.birthplace.country || "";
  }

  function saveData() {
    localStorage.setItem('travel_editor_data', JSON.stringify(data));
    updatePreview();
    updateStats();
  }

  function update() {
    render();
    saveData();
  }
  
  // Ensure schema integrity
  function normalizeData(input) {
    const d = input || {};
    if (!d.person) d.person = { birthplace: { country: "" } };
    if (!d.travel) d.travel = { countries: [] };
    if (!Array.isArray(d.travel.countries)) d.travel.countries = [];
    
    // Normalize each country
    d.travel.countries = d.travel.countries.map(c => ({
      name: c.name || "",
      status: { 
        visited: !!c.status?.visited, 
        lived: !!c.status?.lived, 
        birthplace: !!c.status?.birthplace 
      },
      capitalVisit: { visited: !!c.capitalVisit?.visited },
      timeline: { 
        visited: Array.isArray(c.timeline?.visited) ? c.timeline.visited : [],
        lived: Array.isArray(c.timeline?.lived) ? c.timeline.lived : []
      },
      cities: Array.isArray(c.cities) ? c.cities.map(city => {
        // Normalize city structure
        if (typeof city === 'string') return { name: city, timeline: { visited: [] } };
        return {
          name: city.name || "",
          timeline: { visited: Array.isArray(city.timeline?.visited) ? city.timeline.visited.map(y => parseInt(y)||y) : [] }
        };
      }) : []
    }));
    return d;
  }

  // --- Rendering ---
  function render() {
    els.list.innerHTML = '';
    
    const term = viewState.search.toLowerCase();
    let visibleCount = 0;

    data.travel.countries.forEach((country, index) => {
      // Filtering
      if (term && !country.name.toLowerCase().includes(term)) return;
      visibleCount++;

      const isExpanded = viewState.expanded.has(index);
      const isVisited = country.status.visited;

      const card = document.createElement('div');
      card.className = 'country-card';
      
      // Header
      const header = document.createElement('div');
      header.className = 'c-header';
      header.onclick = (e) => {
        if (e.target.closest('button') || e.target.closest('input')) return;
        toggleExpand(index);
      };

      header.innerHTML = `
        <div class="c-title">
          <input type="text" value="${country.name}" placeholder="Country Name" 
            style="font-weight:bold; background:transparent; border:none; padding:0; width:auto; min-width:150px"
            onchange="app.updateCountryName(${index}, this.value)">
          ${isVisited ? '<span class="badge green">Visited</span>' : ''}
          ${country.status.lived ? '<span class="badge">Lived</span>' : ''}
        </div>
        <div class="c-actions">
           <span class="text-sm" style="margin-right:8px">${country.cities.length} cities</span>
           <button class="btn btn-icon" onclick="app.toggleExpand(${index})">
             ${isExpanded ? 'â–²' : 'â–¼'}
           </button>
           <button class="btn btn-icon btn-danger" onclick="app.deleteCountry(${index})" title="Delete">Ã—</button>
        </div>
      `;

      // Body
      const body = document.createElement('div');
      body.className = `c-body ${isExpanded ? 'open' : ''}`;
      
      if (isExpanded) {
        // Only render body contents if expanded (Performance)
        body.innerHTML = renderBodyContent(country, index);
      }

      card.appendChild(header);
      card.appendChild(body);
      els.list.appendChild(card);
    });

    els.empty.classList.toggle('hidden', visibleCount > 0);
    saveData(); // ensures preview is synced
  }

  function renderBodyContent(country, idx) {
    return `
      <div class="toggles-row">
        <label class="switch-label">
          <input type="checkbox" ${country.status.visited ? 'checked' : ''} onchange="app.updateToggle(${idx}, 'status.visited', this.checked)"> Visited
        </label>
        <label class="switch-label">
          <input type="checkbox" ${country.status.lived ? 'checked' : ''} onchange="app.updateToggle(${idx}, 'status.lived', this.checked)"> Lived
        </label>
        <label class="switch-label">
          <input type="checkbox" ${country.capitalVisit.visited ? 'checked' : ''} onchange="app.updateToggle(${idx}, 'capitalVisit.visited', this.checked)"> Visited Capital
        </label>
      </div>

      <div style="margin-bottom:20px">
        <div class="text-sm" style="font-weight:600; margin-bottom:4px">Years Visited</div>
        <div class="flex-col">
          <div class="tag-container">
            ${country.timeline.visited.map((y, i) => `
              <span class="tag">${y} <button onclick="app.removeTimeline(${idx}, 'visited', ${i})">Ã—</button></span>
            `).join('')}
            <input type="text" placeholder="+ Year" style="width:80px; padding:4px 8px; font-size:0.8rem"
              onkeydown="if(event.key==='Enter'){app.addTimeline(${idx}, 'visited', this.value); this.value=''}">
          </div>
        </div>
      </div>

      <div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px">
          <span class="text-sm" style="font-weight:600">Cities</span>
        </div>
        
        <div class="flex-col">
          ${country.cities.map((city, cIdx) => `
            <div class="city-row">
              <input type="text" value="${city.name}" placeholder="City Name" onchange="app.updateCityName(${idx}, ${cIdx}, this.value)">
              
              <div>
                <div style="display:flex; gap:6px">
                  <input type="number" placeholder="Add Year" class="text-sm" style="width:80px"
                    onkeydown="if(event.key==='Enter'){app.addCityYear(${idx}, ${cIdx}, this.value); this.value=''}">
                </div>
                <div class="year-badges">
                  ${city.timeline.visited.map((y, yIdx) => `
                    <span class="year-badge">${y} <button style="border:none;background:none;padding:0;cursor:pointer;color:var(--danger)" onclick="app.removeCityYear(${idx}, ${cIdx}, ${yIdx})">Ã—</button></span>
                  `).join('')}
                </div>
              </div>

              <button class="btn btn-danger btn-icon" onclick="app.deleteCity(${idx}, ${cIdx})">ðŸ—‘</button>
            </div>
          `).join('')}
        </div>

        <div style="margin-top:12px; display:flex; gap:8px">
          <input type="text" id="newCityName_${idx}" placeholder="New City Name">
          <button class="btn" onclick="app.addCity(${idx})">Add City</button>
        </div>
      </div>
    `;
  }

  // --- Actions ---

  // 1. Countries
  function addCountry() {
    data.travel.countries.unshift({
      name: "",
      status: { visited: false, lived: false, birthplace: false },
      capitalVisit: { visited: false },
      timeline: { visited: [], lived: [] },
      cities: []
    });
    viewState.expanded.add(0); // Auto expand new
    viewState.search = "";
    els.birthplace.value = ""; // Clear search
    update();
  }

  function deleteCountry(idx) {
    if (confirm("Delete this country?")) {
      data.travel.countries.splice(idx, 1);
      // Adjust expanded indices (simple approach: clear expanded or rebuild)
      viewState.expanded = new Set(); 
      update();
    }
  }

  function updateCountryName(idx, val) {
    data.travel.countries[idx].name = val;
    saveData(); // No full re-render needed for text input usually, but helpful for title
  }

  function toggleExpand(idx) {
    if (viewState.expanded.has(idx)) viewState.expanded.delete(idx);
    else viewState.expanded.add(idx);
    render();
  }

  // 2. Toggles & Timeline
  function updateToggle(idx, path, val) {
    // path e.g. 'status.visited'
    const parts = path.split('.');
    if (parts.length === 2) {
      data.travel.countries[idx][parts[0]][parts[1]] = val;
    }
    update();
  }

  function addTimeline(countryIdx, type, val) {
    if (!val) return;
    const clean = val.trim();
    if (clean) {
      data.travel.countries[countryIdx].timeline[type].push(clean);
      data.travel.countries[countryIdx].timeline[type].sort();
      update();
    }
  }

  function removeTimeline(countryIdx, type, itemIdx) {
    data.travel.countries[countryIdx].timeline[type].splice(itemIdx, 1);
    update();
  }

  // 3. Cities
  function addCity(countryIdx) {
    const input = document.getElementById(`newCityName_${countryIdx}`);
    const name = input.value.trim();
    if (name) {
      data.travel.countries[countryIdx].cities.push({
        name: name,
        timeline: { visited: [new Date().getFullYear()] } // Default to now
      });
      update();
    }
  }

  function updateCityName(countryIdx, cityIdx, val) {
    data.travel.countries[countryIdx].cities[cityIdx].name = val;
    saveData();
  }

  function deleteCity(cIdx, cityIdx) {
    data.travel.countries[cIdx].cities.splice(cityIdx, 1);
    update();
  }

  function addCityYear(cIdx, cityIdx, val) {
    const year = parseInt(val);
    if (!isNaN(year)) {
      const arr = data.travel.countries[cIdx].cities[cityIdx].timeline.visited;
      if (!arr.includes(year)) {
        arr.push(year);
        arr.sort((a,b) => a - b);
        update();
      }
    }
  }

  function removeCityYear(cIdx, cityIdx, yearIdx) {
    data.travel.countries[cIdx].cities[cityIdx].timeline.visited.splice(yearIdx, 1);
    update();
  }

  // --- Global Tools ---
  function handleSearch(val) {
    viewState.search = val;
    render();
  }

  function sortCountries(by) {
    data.travel.countries.sort((a, b) => {
      if (by === 'name') return a.name.localeCompare(b.name);
      if (by === 'visited') return Number(b.status.visited) - Number(a.status.visited);
      return 0;
    });
    update();
  }

  function updateStats() {
    const countries = data.travel.countries;
    const visitedCount = countries.filter(c => c.status.visited).length;
    const cityCount = countries.reduce((acc, c) => acc + c.cities.length, 0);
    
    els.statsVisited.textContent = visitedCount;
    els.statsCities.textContent = cityCount;
  }

  function updatePreview() {
    els.preview.textContent = JSON.stringify(data, null, 2);
  }

  function downloadJson() {
    const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'travel_data.json';
    a.click();
    URL.revokeObjectURL(url);
  }

  function copyJson() {
    navigator.clipboard.writeText(JSON.stringify(data, null, 2));
    const btn = event.target;
    const old = btn.textContent;
    btn.textContent = 'Copied!';
    setTimeout(() => btn.textContent = old, 1500);
  }

  function resetData() {
    if(confirm('Reset all data to default?')) {
      data = structuredClone(DEFAULT_DATA);
      viewState.expanded.clear();
      update();
      els.birthplace.value = "";
    }
  }

  function importJson() {
    els.importModal.classList.add('show');
    els.importArea.focus();
  }

  function confirmImport() {
    try {
      const raw = els.importArea.value;
      const parsed = JSON.parse(raw);
      data = normalizeData(parsed);
      viewState.expanded.clear();
      update();
      els.importModal.classList.remove('show');
      els.birthplace.value = data.person.birthplace.country || "";
    } catch(e) {
      alert("Invalid JSON format");
    }
  }

  // Expose public methods
  return {
    init, handleSearch, addCountry, deleteCountry, toggleExpand,
    updateCountryName, updateToggle, addTimeline, removeTimeline,
    addCity, updateCityName, deleteCity, addCityYear, removeCityYear,
    sortCountries, downloadJson, copyJson, resetData, importJson, confirmImport
  };

})();

// Start
app.init();
</script>
</body>
</html>
